# 浅析计算机存储系统：从磁盘到内存

    本文涉及到的 Linux 内核版本为2.4+

## 前言

把一个计算机系统模型高度简化之后来看的话其实一共就只有两个部分，一个是cpu，用于执行各种指令，另一个是存储器系统为cpu存放指令和数据。对一只普通小码农而言，日常工作中基本上是没什么机会和cpu打交道的，而对于经常打交道的同时也是对程序性能有着极大影响的存储系统更多的时候是处于一种一知半解的状态，就是知道很多碎片化的知识，但是相互之间不能够很好地串起来，从而形成一个比较完整的了解，比如如下的一些场景：

1. 我们或许知道在进程运行过程中删除了文件但是用df命令去看会发现磁盘空间并不会被释放，那么我们能说清楚这个现象的原因吗？以及删除文件的这个操作具体都删除了什么东西呢？还有所谓的磁盘空间又是个什么东西呢？
2. 作为一个java程序员，我们肯定都知道堆内内存，堆外内存，直接内存巴拉巴拉等一系列jvm中和内存相关的概念，那么这些内存和所谓的物理内存之间又是什么关系呢？如果用了1G的堆内存那么也会占用1G的物理内存吗？如果虚拟机回收了1G的堆内存那么物理内存也会被释放掉吗？堆内存是由虚拟机来进行垃圾回收的，那物理内存又是谁以及如何分配和回收的呢？

为了真正搞懂上面的这些问题，同时也为了把一些碎片知识串起来，专门花了几个周末的时间查阅了相关的一些资料和源码，基本上对于存储系统这一块有了一个整体的了解，当然能够说出来才谈得上了解，所以打算就这部分内存整理一篇文章出来，也就是本文。

## 存储器层次结构

要弄明白存储系统首先得对存储器有一些基本的了解，现代计算机的存储系统是由具有不同容量/成本/访问时间的存储器组合在一起形成的一个层次结构，按照相对CPU距离的远近存储器可以被划分为:寄存器(register)/高速缓存(cache)/主存(memory)/磁盘(disk)/其他,其主要作用如下：

### 寄存器(Register) & 高速缓存(Cache)

这两部分都位于CPU中是CPU的一部分，其中L1/L2 Cache和寄存器在Core中，L3在Die中，所以就放到一起来介绍了，而要理解寄存器和cahe的作用我们得对CPU的物理架构和工作原理有一些基础的了解，所以我们先来简单介绍一下CPU

#### 一些关键名词

以下是会涉及到的一些名词

**CPU**：封装完成后可售卖的CPU，我们装机的时候买的就是这个
![CPU](https://cdn.jsdelivr.net/gh/shareImage/image@_md2zhihu_blog_cee8f3b4/CPU%E7%9A%84%E5%88%B6%E9%80%A0%E5%92%8C%E6%A6%82%E5%BF%B5/dataf1-1372099277050.jpg)

**Die**: 从晶圆上切割下来的未封装的CPU，通常一个Die中包含多个core、L3cache、北桥、GPU
![die](https://cdn.jsdelivr.net/gh/shareImage/image@_md2zhihu_blog_cee8f3b4/CPU%E7%9A%84%E5%88%B6%E9%80%A0%E5%92%8C%E6%A6%82%E5%BF%B5/xCqqv.jpg)

**Core**: CPU核，我们常说的几核几G中的核就是指Core，一个Core中会包含 寄存器，L1/L2 Cache，译码器，时序脉冲发生器，ALU，我们经常谈论的 （控制单元 + 存储单元 + 运算单元）所代指的`CPU`其实就是Core

intel Skylake 架构图 ![Skylake](https://cdn.jsdelivr.net/gh/shareImage/image@_md2zhihu_blog_cee8f3b4/CPU%E7%9A%84%E5%88%B6%E9%80%A0%E5%92%8C%E6%A6%82%E5%BF%B5/950px-skylake_server_block_diagram.svg.png)

**封装**：将一个或多个Die封装成一个物理上可以售卖的CPU

**晶圆**：一大片纯硅圆盘，CPU电路的实际载体，由光刻机在上面蚀刻出电路，可以被切割为很多个Die

#### CPU基础架构和工作原理

寄存器就是我们学汇编的时候经常用到的一些
我们知道CPU的主要功能就是计算，其工作流程简单来说就是从指令寄存器中拿到

其中寄存器和高速缓存都位于CPU中，例如我们写汇编时会用到的rsp就是X68_64架构下的16个通用寄存器之一，而经常看到的L1/L2/L3 Cache就是指的高速缓存，其中L1 和 L2 都在Core(也就是我们说的核)中,L3则是多核共享的(ps:其实了解了cache的结构就很容易弄明白jmm(Java Memory Model)中为什么会有主存和工作内存的概念，因为从物理结构上每个core的l1/l2 cache就是独享的)

## 文件系统


## 内存管理
### linux内存管理
### JVM 内存管理

## 总结

ok，要写的内容基本上就写完了，现在是时候来填在文章开头埋的坑了，也就是前言里面提到的那几个问题的答案。

1. 为什么删除文件后磁盘空间未被释放

        todo
2. 删除文件都删除的是什么东西

        todo
3. 磁盘空间是指什么
        
        todo

4. 堆内存和物理内存的关系

        todo
5. 物理内存的分配回收策略

        todo

## 参考文章

1. https://ata.alibaba-inc.com/articles/211563#kUUOdhrR
2. http://blog.chinaunix.net/uid-23069658-id-3563960.html?page=2
